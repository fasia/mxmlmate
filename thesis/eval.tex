\section{Evaluation}
\label{sec:evaluation}
From the previous sections you should be familiar with the main ideas and even some technical details behind
the approach that is the main focus of this document. However, every approach is only worth as much as it can
offer. To determine this for the presented implementation - \xmlmate, an empirical evaluation on several test
subjects has been carried out, and the results are documented in this section.
\subsection{Evaluation Setup}

Due to the random nature of the genetic algorithm that is at the heart of \xmlmate, it is necessary to perform
multiple runs of each experiment in order to properly ascertain its effectiveness and efficiency statistically
by considering the average values. At this point it is of particular importance to define what efficiency and
effectiveness mean in the context of this document. 

In terms of found defects, let \emph{efficiency} be the overall number of defects found in a given time frame.
Similarly, \emph{effectiveness} is the number of \emph{unique} defects revealed within a given time frame.

One \emph{experiment} consists of running \xmlmate for one hour with a limit of 2200 elements per \xml instance
as well as a maximum recursion depth of 12 for optional elements meaning that no optional elements are generated
for subtrees of depth 13 or more. Additionally, the maximum number of \xml files in the population being
evolved is limited to 500 which is kept consistent across the normal and the singleton population (see
\cref{sec:memcov}) modes as follows: in the singleton population usage scenario, where single files are the
main focus of the evolution process, the limit is expressed simply as a single suite with a maximum of 500
individual files in it, while in the normal use case, where the result of an evolution is a suite of files, the
limit is enforced as a population of 25 suites with a maximum of 20 files in each.

To produce statistically significant average result values, for each fitness function and for each test
subject an experiment was run 10 times. This setup was replicated for the two modes of testing: with and
without the mechanism for producing schema-invalid values.

The experiments were carried out on a virtual machine equipped with 8 CPU cores running at 2.60GHz and 64 Gb
main memory, which, however, was far more than needed because the \java part of \xmlmate{} - the process taking
up the most memory by far - only needed 2Gb for in-memory \xml instance handling. The deployment configuration
of the \xmlmate system consisted of the following:

\begin{itemize}
  \item 1 instance of the \java \xmlmate core component
  \item 1 load balancer between the core component and converter instances
  \item 8 format converter instances
  \item 1 load balancer between the converters and the workers
  \item 8 worker instances (worker = test driver + test subject instance + pintool)
  \item 8 lifeguards for their respective workers
\end{itemize}

The setup can be imagined as in \cref{fig:components} with $n = m = 8$.
It must be noted that no converters were used for testing \texttt{libxml2} as it consumes inputs as generated
by the \xmlmate core component directly, therefore only one load balancer was needed between it and
the worker instances.

\subsection{Subjects}
While \cref{sec:formats} has introduced you to the file formats used in this document, the following sections
will give you a short description of programs that were used during the evaluation, which work with those
formats.
\subsubsection{libxml2}
\texttt{libxml2}\footnote{\url{http://www.xmlsoft.org/}} is a library for processing generic \xml documents,
which is written in {\small C}. It is widely used and provides bindings to many programming languages
including \cpp, {\small C\#}, \python{}, {\small Ruby}, {\small PHP5}, and {\small Perl}. Furthermore, it was
designed for utmost portability, such that it works on a wide variety of operating systems such as
Linux, Windows, CygWin, MacOS, RISC Os, OS/2, and some other, less common ones. Notably, the Google Chrome
browser uses \texttt{libxml2} internally, which further shows the library's popularity.

The library is extremely well tested, and in its current version 2.9.2 it passes all tests from the very large
OASIS XML Test Suite\footnote{\url{https://www.oasis-open.org/committees/xml-conformance/xml-test-suite.shtml}}
consisting of more than 1800 individual tests. It is, therefore, very unlikely for \xmlmate to find any
vulnerabilities or even defects, especially because it specializes in generating \emph{valid} XML files, and
even more so in this case, where only \texttt{xhtml} files, which do not represent the entirety of the \xml
specification, were used for testing.

Since in its main functionality this library acts like a parser, the interface for performing testing with
\xmlmate is correspondingly simple: the test driver engages the library under test by passing it a file to be
parsed and loaded into memory, whereafter the file is unloaded. No additional walks are performed, which
sacrifices a lot im terms of achieved fitness scores, but wins out multiple times over in the
overall execution speed.

% download from https://git.gnome.org/browse/libxml2/refs/tags

\subsubsection{libpcap}
\texttt{libpcap}\footnote{\url{http://www.tcpdump.org/}} is a library for working with the \pcap file format
maintained by the \emph{Tcpdump Group}. It is used in the popular tools tcpdump, ngrep, Wireshark, Snort and
nmap, among other less known ones. The main objective of \texttt{libpcap} is to provide its users with a
platform-independent API for network packet capturing. The API is designed to work with the {\small C} and \cpp
programming languages, but there exists a number of bindings to other languages as well such as \python, \java,
{\small C\#}, or {\small Ruby}.

While it first and foremost provides a nice abstraction layer above the operating system-specific live packet
capturing mechanism (which every operating system vendor seems to have designed differently), \texttt{libpcap}
also provides an interface for manipulating packets already captured and available in the \pcap file format.
This is the interface through which testing with \xmlmate is performed as it seems otherwise rather
infeasible to simulate a network card interface in order to engage \texttt{libpng} on the live capturing
interface. One consequence to choosing the offline  file reading interface is, however, that only a relatively
small portion of the program code of \texttt{libpcap} can be possibly engaged. This limitation has to be kept
in mind when assessing the results of the empirical evaluation presented in this section. It is also noteworthy
to mention that to date there are no known vulnerabilities in \texttt{libpcap} itself, while both tcpdump and
Wireshark seem to have corresponding CVE entries in internet vulnerability databases e.g.
\url{http://www.cvedetails.com}.

\subsubsection{libpng}
\texttt{libpng}\footnote{\url{http://www.libpng.org/}} is a ubiquitous library for manipulating, reading,
writing and generally handling \png files. It is available freely under a permissive license, and thus very
widely used in a wast number of both free and proprietary software products. The \texttt{libpng} library is
written in the {\small C} programming language with a dependency on the \texttt{zlib} library, on which it
relies for data compression. It is considered to be the reference implementation for all possible interactions
one can have with a \png file, perhaps with the exception of steganography - the practice of concealing
messages inconspicuously inside image files.

In its 18 years of existence, the library was extensively tested as it evolved and matured. Ever since the very
early versions it provides \emph{pngtest} - a utility that allows to test a \png file for conformance with the
\png file format. This process involves reading and parsing the file, storing it in memory, performing some
transformations on it, writing it out to disk again, and comparing the result with the original input file.
This seems like a good representation of the usual use case for this library, which is why it was chosen as
the interface at which testing with \xmlmate was performed. The test driver for \texttt{libpng} basically
consists of pngtest itself only slightly modified to enable communication with \xmlmate via \zmq. In order not
to waste computational resources, one limitation was imposed on the images generated by \xmlmate: their size
was limited to two by two pixels because most defects found in \texttt{libpng} originated from specific values
in the metadata rather than image data itself.

%\subsubsection{libflac}
\subsection{Results}

% mention segfault found in gimp due to empty PLTE
% mention problem of failure masking -> one crash makes another undetectable
% mention singleton pop mode for the last 4 fit funcs
% mention in table tbl:fitness downarrow means div0 fitness function is minimization function

\begin{table}[H]
\small
\centering
\begin{tabular}{|r|c|r|r|r|r|r|r|}
\hline
\multicolumn{1}{|c|}{Subject}  & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Schema\\ Valid\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}BBL\\ Coverage\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}BBL\\ Succession\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Memory\\ Access\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}$\downarrow$ Division\\ by 0\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Integer\\ Overflow\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Buffer\\ Overflow\end{tabular}} \\ \hline \hline
                               & +                                                                           &     ?                                                                       &         ?                                                                     &             ?                                                                &                     ?                                                        & 4.61146E18                                                                      & 2102329                                                                        \\ \cline{2-8} 
\multirow{-2}{*}{png}          & \cellcolor[HTML]{C0C0C0}-                                                   & \cellcolor[HTML]{C0C0C0} 15330                                              & \cellcolor[HTML]{C0C0C0} 11657                                                & \cellcolor[HTML]{C0C0C0} 66493                                               & \cellcolor[HTML]{C0C0C0}                                                     & \cellcolor[HTML]{C0C0C0}              ?                                         & \cellcolor[HTML]{C0C0C0}    ?                                                  \\ \hline \hline
                               & +                                                                           &              ?                                                              &                             ?                                                 &                                ?                                             &                                         ?                                    &                                        ?                                        &                                 ?                                              \\ \cline{2-8} 
\multirow{-2}{*}{pcap}         & \cellcolor[HTML]{C0C0C0}-                                                   & \cellcolor[HTML]{C0C0C0} ?                                                  & \cellcolor[HTML]{C0C0C0} 192                                                  & \cellcolor[HTML]{C0C0C0} 470                                                 & \cellcolor[HTML]{C0C0C0} 9.22337E18                                          & \cellcolor[HTML]{C0C0C0} 7.03686E13                                             & \cellcolor[HTML]{C0C0C0} 2175408                                               \\ \hline \hline
                               & +                                                                           &       ?                                                                     &                              ?                                                &                                 ?                                            &                                        ?                                     &                                         ?                                       &                                      ?                                         \\ \cline{2-8} 
\multirow{-2}{*}{xhtml}        & \cellcolor[HTML]{C0C0C0}-                                                   & \cellcolor[HTML]{C0C0C0}    ?                                               & \cellcolor[HTML]{C0C0C0} ?                                                    & \cellcolor[HTML]{C0C0C0}  ?                                                  & \cellcolor[HTML]{C0C0C0}    ?                                                & \cellcolor[HTML]{C0C0C0}  ?                                                     & \cellcolor[HTML]{C0C0C0}   ?                                                   \\ \hline
\end{tabular}
\caption{Fitness Score Results}
\label{tbl:fitness}
\end{table}


\begin{table}[H]
\small
\centering
\begin{tabular}{|c||r|r|r|r|r|r|}
\hline
\begin{tabular}[c]{@{}c@{}}Schema\\ Valid\end{tabular} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}BBL\\ Coverage\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}BBL\\ Succession\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Memory\\ Access\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Division\\ by 0\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Integer\\ Overflow\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Buffer\\ Overflow\end{tabular}} \\ \hline
+ & ? & ? & ? & ? & 9.2 (0.1) & 12.9 (0.1) \\ \hline
- & 1.8 (0.1) & 1.6 (0.1) & 1.2 (0.1) & ? & ? & ? \\ \hline
\end{tabular}
\caption{Average Crashes Found in \texttt{libpng}}
\label{tbl:png:crashes:avg}
\end{table}


\begin{table}[H]
\small
\centering
\begin{tabular}{|c||r|r|r|r|r|r|}
\hline
\begin{tabular}[c]{@{}c@{}}Schema\\ Valid\end{tabular} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}BBL\\ Coverage\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}BBL\\ Succession\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Memory\\ Access\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Division\\ by 0\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Integer\\ Overflow\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Buffer\\ Overflow\end{tabular}} \\ \hline
+ & ? & ? & ? & ? & 92 (1) & 129 (1) \\ \hline
- & 18 (1) & 16 (1) & 12 (1) & ? & ? & ? \\ \hline
\end{tabular}
\caption{Cumulative Crashes Found in \texttt{libpng}}
\label{tbl:png:crashes:cum}
\end{table}

% as found in https://wiki.mmci.uni-saarland.de/syssec/Vulnerabilities/libpng
\begin{table}[H]
\centering
\begin{tabular}{|c|l|c|}
\hline
Vulnerability & Type & Version \\ \hline
CVE-2013-6954 & *Null & ? \\ \hline
CVE-2011-3328 & DivBy0 & 1.5.4 \\ \hline
CVE-2011-3048 & malloc fails & ? (need mem limit) \\ \hline % might have to lift 2x2 pixel limit
CVE-2011-2691 & *Null & ? (PNG\_ERROR\_TEXT\_SUPPORTED must be undefined) \\ \hline
CVE-2008-1382 & Segfault & 1.2.25 \\ \hline
\end{tabular}
\caption{Vulnerabilities and \texttt{libpng} Versions}
\label{tbl:png:vulns}
\end{table}

\subsection{Threats to Validity}
As any empirical study, this evaluation is subject to several threats to validity.
First, as regards \emph{external validity}, the subjects used in this study may be far from representative of
the entirety of all applications now compatible with \xmlmate, and may even be uncharacteristic among their
respective application class.

Concerning \emph{internal validity} it must be kept in mind that search-based testing is random in nature, and
thus the results may vary greatly over multiple experiments. Some effort was made to mitigate this problem by
performing multiple runs and taking the average results. However, it is unclear if a much larger sample size
would alter the results in any significant way.

Furthermore, the choice of many of the parameters for the genetic algorithm such as population size,
genetic operation probabilities, or chromosome limitations might not have been optimal for the chosen test
subjects.

Regarding \emph{construct validity} it is uncertain if the metrics used in the evaluation are well suited
to adequately measure the usefulness of the presented approach.
 
% partial bias -> pcap schema and converter was written by me, I tried to adhere to the specs